<div class="container mx-auto my-5">
  <mat-spinner *ngIf="isLoading"></mat-spinner>
  <div *ngIf="!isLoading">
    <div class="row mt-2">
      <div class="col-2">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <p class="m-0 text-gray"><i class="bi bi-house-door-fill"></i> {{ selectedOrga.name }}</p>
        </div>
        <mat-nav-list>
          <mat-divider></mat-divider>
          <a mat-list-item *ngFor="let section of sections; let i = index" (click)="selectSection(section, i)"
            [ngClass]="{'selected': selectedSection && selectedSection.jobId === section.jobId, 'completed': completedSections[section.jobId]}">
            <span class="fw-bold text-gray">{{ section.title }}:</span>
          </a>
        </mat-nav-list>
      </div>

      <div class="col-10">
        <!-- EMPTY STATE + PROGRESS BAR -->
        <div class="progress-bar my-2">
          <mat-progress-bar mode="determinate" [value]="progressValue"></mat-progress-bar>
        </div>
        <div *ngIf="!selectedOrga" class="alert alert-info">
          Bitte geben Sie zunächst Ihren Willkommenscode ein.
          <a class="link" href="/app/evaluation" class="btn btn-primary redirect link"
            aria-label="Zurück zum Willkommenscode">Zum Willkommenscode</a>
        </div>
        <div *ngIf="selectedOrga && !selectedSection" class="alert alert-info">
          Noch keine Daten ausgewählt. Bitte klicken Sie links auf einen der Abschnitte.
        </div>
        <div *ngIf="selectedSection && !moduleDataAvailable" class="alert alert-info">
          Für diesen Abschnitt muss keine Zuordnung getroffen werden.
        </div>
        <div class="row" *ngIf="selectedSection && moduleDataAvailable">
          <div class="col-6">
            <div *ngIf="selectedSection">
              <div class="job-box my-2">
                <div class="title-actions-wrapper d-flex align-items-center justify-content-between">
                  <div class="title-text text-truncate" [title]="selectedSection.title">Ranking für <span
                      class="job-details fw-bold">{{
                      selectedSection.title }}</span></div>
                  <div class="actions-wrapper d-flex gap-2">
                    <button class="btn btn-outline bg-white" (click)="copyToClipboard(selectedSection!.desc!)"
                      matTooltip="In die Zwischenablage kopieren">
                      <i class="bi bi-clipboard btn-icon"></i>
                    </button>
                    <button class="btn btn-outline bg-white" (click)="openInNewTab(selectedSection!.title!)"
                      matTooltip="In einem neuen Tab öffnen">
                      <i class="bi bi-box-arrow-up-right btn-icon"></i>
                    </button>
                  </div>
                </div>
                <div #descContainer class="toggable-text" [class.collapsed]="jobToggled"
                  [innerHTML]="selectedSection.desc! | jobFormat">
                </div>
                <div class="show-more d-flex justify-content-center">
                  <button class="btn btn-sm btn-outline text-blue" (click)="toggleJobDesc()"
                    (keyup.enter)="toggleJobDesc()">
                    {{ jobToggled ? 'Ausklappen' : 'Einklappen' }}
                  </button>
                </div>
              </div>
              <div *ngFor="let area of dropAreas; let i = index" class="drop-area p-2"
                [cdkDropListConnectedTo]="allDropLists" cdkDropList id="drop-list-{{i}}"
                [cdkDropListData]="dropAreas[i]" (cdkDropListDropped)="drop($event)">
                <p class="text-gray" *ngIf="dropAreas[i].length === 0">Platz {{ i + 1 }}</p>
                <mat-card class="item-card p-1 mb-0" *ngFor="let item of dropAreas[i]; let j = index" cdkDrag
                  [cdkDragData]="item">
                  <div class="d-flex justify-content-between align-items-center"
                    matTooltip="Klicken Sie auf das Modul, um die Modulbeschreibung einzusehen."
                    (click)="viewModule(item)" (keyup.enter)="viewModule(item)">
                    <span><span class="fw-bold text-gray me-2">{{item.acronym}}:</span>{{ item.name }}</span>
                  </div>
                </mat-card>
              </div>
              <!-- drop area for irrelevant candidates -->
              <div class="drop-area-irrelevant p-2 mt-3" [cdkDropListConnectedTo]="allDropLists" cdkDropList
                id="drop-list-irrelevant" [cdkDropListData]="irrelevantItems" (cdkDropListDropped)="drop($event)">
                <p class="text-gray" *ngIf="irrelevantItems.length === 0">Nicht relevant</p>
                <mat-card class="item-card p-1  mb-1" *ngFor="let item of irrelevantItems; let j = index" cdkDrag
                  [cdkDragData]="item">
                  <div class="d-flex justify-content-between align-items-center"
                    matTooltip="Klicken Sie auf das Modul, um die Modulbeschreibung einzusehen."
                    (click)="viewModule(item)" (keyup.enter)="viewModule(item)">
                    <span><span class="fw-bold text-gray me-2">{{item.acronym}}:</span>{{ item.name }}</span>
                  </div>
                </mat-card>
              </div>
              <div class="d-flex justify-content-end my-3">
                <label for="comment">Kommentar (optional):</label>
                <textarea id="comment" [(ngModel)]="comment" class="form-control" rows="2"
                  (ngModelChange)="onCommentChange()"></textarea>
              </div>
              <button class="save-btn btn btn-primary w-100" [disabled]="!isSaveEnabled() || isLoading"
                (click)="saveSelection()"><span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"
                  role="status"></span>
                {{ isLoading ? 'Speichert...' : 'Speichern' }}</button>
              <span class="invalid">
                Bitte ordnen Sie alle Module einem Feld zu, bevor Sie speichern.
              </span>
            </div>
          </div>
          <div class="col-6">
            <div class="sticky-container" *ngIf="selectedSection">
              <div class="info-box-petrol">
                Bitte ordnen Sie alle Module nach Ihrer Relevanz für den entsprechenden Job entweder im Ranking oder
                im Feld "Nicht relevant" ein. Mehrfachzuordnungen sind pro Feld möglich.
              </div>
              <div cdkDropList id="candidates-list" [cdkDropListConnectedTo]="allDropLists"
                [cdkDropListData]="candidates" (cdkDropListDropped)="drop($event)">
                <mat-list>
                  <mat-list-item *ngFor="let candidate of candidates" cdkDrag [cdkDragData]="candidate" class="mb-1">
                    <mat-card class="item-card mb-1">
                      <div class="d-flex justify-content-between align-items-center"
                        matTooltip="Klicken Sie auf das Modul, um die Modulbeschreibung einzusehen."
                        (click)="viewModule(candidate)" (keyup.enter)="viewModule(candidate)">
                        <span><i class="bi bi-arrows-move me-2"></i><span
                            class="fw-bold text-gray me-2">{{candidate.acronym}}:</span><span>{{ candidate.name
                            }}</span></span>
                      </div>
                    </mat-card>
                  </mat-list-item>
                </mat-list>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>